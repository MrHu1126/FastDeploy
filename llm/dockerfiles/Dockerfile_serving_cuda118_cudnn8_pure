FROM registry.baidubce.com/paddlepaddle/fastdeploy:llm-base-gcc12.3-cuda11.8-cudnn8-nccl2.15.5

WORKDIR /opt/output/

ENV http_proxy "http://172.19.57.45:3128"
ENV https_proxy "http://172.19.57.45:3128"
ENV LD_LIBRARY_PATH "/usr/local/cuda-11.8/compat/:$LD_LIBRARY_PATH"

RUN pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple
RUN python3 -m pip install --pre paddlepaddle-gpu -i https://www.paddlepaddle.org.cn/packages/nightly/cu118/ \
    && python3 -m pip install paddlenlp==3.0.0b0

RUN git clone https://gitee.com/paddlepaddle/PaddleNLP.git && cd PaddleNLP/csrc \
    && python3 setup_cuda.py build && python3 setup_cuda.py install --user \
    && cp -r /opt/output/PaddleNLP/paddlenlp /usr/local/lib/python3.10/dist-packages/ \
    && cp -r /root/.local/lib/python3.10/site-packages/* /usr/local/lib/python3.10/dist-packages/ \
    && rm -rf PaddleNLP

RUN git clone https://github.com/PaddlePaddle/FastDeploy.git \
    && cd FastDeploy/llm \
    && python3 -m pip install -r server/requirements.txt

ENV http_proxy ""
ENV https_proxy ""
ENV TZ=Asia/Shanghai
